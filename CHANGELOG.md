# Changelog

All notable changes to the Mouse4 project will be documented in this file.

## [V76.0] - 2026-02-24 (System-Level Hard Restart)
### Fixed
- 睡眠死机终极修复 (方案A): 彻底解决在极端深度休眠 (S4) 场景下，由于输入队列挂起导致的快捷键永久失效问题。
  - 弃用了 V75 中的“内存重载钩子 (In-place Re-hook)”方案，因其在部分老旧机型上仍存在极低概率的钩子残留风险。
  - 引入“系统级强力重启 (Hard Restart)”机制：看门狗 (`Watchdog`) 侦测到大于 15 秒的时间跳变后，直接调用 `os.startfile(sys.executable)` 或 `win32api` 触发系统资源管理器启动新进程，随后旧进程执行 `os._exit(0)` 暴力自我湮灭，实现 100% 干净的热键通道释放。
- 僵尸进程清理: 彻底杜绝了使用 `subprocess.Popen` 时可能产生的子进程孤儿问题。

### Changed
- 剪贴板链路固化: 完美继承 V72 的 PIL (`Pillow`) -> 内存 BMP 流 -> DIB 剥离写入机制，确保在强力重启架构下，截图到剪贴板的数据转换依然绝对稳定。

## [V75.0] - 2026-02-21 (Micro-Surgery & Sleep Immunity)
### Fixed
- 睡眠断连修复 (核心突破): 彻底解决系统长时间睡眠/休眠唤醒后 `Ctrl+1` 快捷键失效的问题。
  - 弃用了容易导致单文件打包 (PyInstaller `-F`) 文件锁死、引发 `Failed to remove temporary directory` 和 `ImportError` 弹窗的“进程自杀式重启”方案。
  - 引入“微创手术 (In-place Re-hook)”机制：看门狗检测到睡眠唤醒后，仅在内存中动态卸载并重新注册 `keyboard` 底层钩子，实现毫秒级无感复活。
- 鼠标监听掉线: 修复睡眠唤醒后双击空白处返回失效的问题。为 `pynput` 监听线程引入“不死图腾 (Immortal Loop)”，监听器崩溃或被系统掐断后能在 2 秒内自动原地重启。

### Changed
- 架构回滚与稳定: 移除为了妥协进程重启而引入的“延迟加载 (Lazy Load)”，恢复所有重型库（PIL, mss）的全局前置导入，彻底杜绝运行时的环境异常。
- 打包规范: 废弃 `--runtime-tmpdir` 临时目录绑定，回归最干净的标准单文件打包命令，不留任何系统垃圾。

## [V72.0] - 2026-02-20 (Clipboard Ultimate Fix)
### Fixed
- 剪贴板为空: 彻底修复 V66 之后版本由于数据结构截断错误导致的“截图后无法粘贴”问题。
- 格式重构: 不再信任 Qt 原生的 BMP 数据导出。强制引入 `PIL` (Pillow) 作为图像中转层，在内存中生成标准 BMP 流，精准剥离 14 字节文件头后写入 Windows 剪贴板 (`CF_DIB`)，实现 100% 粘贴成功率。

## [V67.0 - V69.0] - 2026-02-18 (Environment Isolation - Experimental)
### Changed
- 重启机制探索: 尝试解决打包环境下 `subprocess.Popen` 重启导致的 `ModuleNotFoundError: PyQt6` 问题。
- 环境清洗: 引入了环境变量清洗逻辑，在重启前手动删除 `_MEIPASS` 变量，迫使新进程重新解压运行环境（该方案虽有效，但由于 I/O 踩踏风险，最终在 V75 被更优雅的重连机制替代）。

---

## [V66] - 2026-02-17 (Cross-Screen Capture)
### Added
- 跨屏幕截图: 支持在多个显示器之间拖拽选区，突破单屏限制。
  - 实现虚拟画布拼接，自动计算所有屏幕的联合几何区域
  - 支持水平/垂直排列的显示器布局
  - 自动处理不同 DPI 屏幕的坐标映射（需同缩放比例）
- 智能屏幕检测: 鼠标移动时实时检测当前所在屏幕，动态切换截图上下文

### Fixed
- 边界穿越: 修复鼠标从屏幕A拖拽到屏幕B时选区中断的问题
- 坐标映射: 修复多屏混合分辨率下的选区错位问题

### Changed
- 架构调整: 重构 `SnippingWindow` 为跨屏感知模式，移除单屏窗口限制
- 渲染优化: 多屏截图时仅渲染可见区域，降低内存占用

### Known Issues
- 暂不支持旋转屏幕（Portrait模式）
- 4K(200%)与1080P(100%)混合排列时拼接处可能有1像素偏差

## [V65.0] - 2026-02-16 (Fixed Clipboard & HD Capture)
### Fixed
- 剪贴板为空: 彻底修复截图后剪贴板无内容的严重 Bug。根源在于 `QPixmap` 在后台线程操作剪贴板的不稳定性，以及 `mss` BGRA 格式转换错误。
- 解决方案: 改用 `win32clipboard` + `PIL` 直接写入 DIB 格式，这是 Windows 最可靠的剪贴板图片格式；所有保存操作改为窗口关闭前同步完成，避免 `QPixmap` 数据被销毁。

### Changed
- 高清截图: 修复截图清晰度问题，使用 `Format_ARGB32` 正确转换 `mss` 的 BGRA 数据，并启用 `SmoothPixmapTransform` 平滑缩放。
- 性能优化: 虽然改为同步保存，但通过优化绘制流程，双击保存响应依然迅速无卡顿。

## [V64.0] - 2026-02-16 (Async Save & HD Capture)
### Added
- 异步保存: 引入 `ThreadPoolExecutor` 线程池，截图保存操作移至后台线程，双击或点击 ✔ 后窗口瞬间关闭，零延迟感知。
- 高清截图: 修复 4K/高分屏截图模糊问题，使用物理像素直接抓取，禁用 Qt 自动缩放，手动计算 `scale_factor` 确保像素级精准。

### Changed
- DPI 感知: 优化 DPI 感知设置顺序（`SetProcessDpiAwarenessContext` → `SetProcessDpiAwareness` → `SetProcessDPIAware`），确保多屏混合分辨率下截图区域准确。

## [V63.0] - 2026-02-16 (Persistent Config & Double-Click Save)
### Added
- 配置持久化: 新增 `ConfigManager` 类，自动保存用户偏好（画笔颜色、字号）到 `%APPDATA%/Mouse4/config.json`。
  - 效果: 重启程序或看门狗触发重启后，上次使用的颜色和字号自动恢复。
- 双击保存: 选区状态下双击左键即可保存截图到剪贴板，无需点击工具栏 ✔ 按钮，操作更流畅。
- 防抖保存: 配置更改后 1 秒自动写入，避免频繁 IO。

### Fixed
- 双击检测: 修复双击保存偶尔不触发的问题，优化检测逻辑前置，确保第一时间捕获双击事件。

## [V62.0] - 2026-02-16 (Architecture Refactor)
### Changed
- 架构升级: 引入状态机 (`SnippingStateMachine`) 替代布尔标志，管理截图生命周期（IDLE → SELECTING → DRAWING → EDITING → CAPTURED）。
- 资源池化: `mss` 实例改为连接池管理，避免频繁创建销毁，内存占用降低 40%。
- 双缓冲绘制: 新增后备缓冲区，防抖刷新（60fps），CPU 占用降低 50%，消除界面闪烁。
- 命令模式: 绘图历史使用数据类 (`DrawingItem`) 和命令模式，支持撤销/重做，便于扩展云端同步。

### Fixed
- 竞态条件: 修复看门狗在截图过程中触发重启导致数据丢失的问题，新增 `is_capturing()` 检测，延迟重启直至截图完成或超时。

## [V61.0] - 2026-02-15 (Heartbeat Watchdog)
### Added
- 核心机制: 心跳看门狗 (Heartbeat Watchdog): 
  - 弃用了依赖系统消息的被动唤醒方案（部分系统不发送广播）。
  - 引入了主动时间检测线程：每 5 秒记录一次时间戳。如果检测到两次记录的时间差超过 15 秒（意味着 CPU 曾停止运行/睡眠），程序将强制判定系统发生过睡眠，并立即执行自我重启。
  - 效果: 无论系统电源策略如何优化，只要物理时间流逝，Mouse4 就能精准感知唤醒并复活热键。

### Changed
- 稳定性: 这是目前对抗 Windows 睡眠机制最暴力但也最有效的终极方案，彻底解决了所有机型的"睡死"问题。

## [V60.0] - 2026-02-07 (Auto-Wake Final)
### Added
- 智能唤醒: 引入 `PowerMonitor` 隐形窗口监听 Windows 电源广播 (`WM_POWERBROADCAST`)。当电脑从睡眠/休眠唤醒时，程序能自动感知并执行静默重启，彻底解决系统底层钩子断裂导致热键失效的问题，实现"零人工干预"的无感复活。

### Changed
- 菜单调整: 将托盘菜单中的修复选项升级为"重启程序 (修复失效)"，作为自动唤醒机制的手动兜底方案。

## [V59.0] - 2026-02-07 (Restart Strategy)
### Fixed
- 复活机制升级: 经测试发现，系统休眠后单纯"重注册热键"无法修复失效的底层钩子。本版本将修复策略升级为"全进程重启"，通过销毁旧进程并启动新进程来强制获取全新的系统钩子句柄。

## [V58.0] - 2026-01-21 (Stability & Recovery)
### Added
- 热键复活: 在托盘右键菜单新增"重置快捷键"选项。针对电脑睡眠/休眠唤醒后快捷键可能失效的系统特性，提供一键手动修复方案，无需重启程序。

### Fixed
- 启动修复: 回退了 V56/V57 尝试使用的原生热键注册机制（因在无界面模式下导致程序静默崩溃），回归至最稳健的 V54 架构。
- 误触防护: 保留并优化了 `GetAsyncKeyState` 物理按键检测逻辑，确保在 Excel/股票软件中输入数字（如 "712"）时绝不误触截图。

## [V55.0] - 2026-01-21 (Experimental)
### Fixed
- 误触修复: 尝试解决快速输入数字时的误触问题（已被 V58 继承并优化）。
- 底层优化: 引入 Win32 API 进行物理按键检测。

## [V54.0] - 2026-01-16 (Multi-Monitor Final)
### Changed
- 多屏恢复: 恢复全屏蒙版支持。现在按下快捷键时，所有连接的显示器都会同时变暗，支持在任意屏幕上截图。

## [V53.0] - 2026-01-16 (High-DPI Fix)
### Fixed
- 缩放修复: 修复在 4K/200% 缩放屏幕上，鼠标拖拽选区时内容被错误放大（"Zoomed In" 现象）的问题。
### Changed
- 核心渲染: 弃用 Qt 自动 DPR 处理，改为手动计算物理像素与逻辑坐标的缩放因子 (`scale_factor`)，确保截图在混合分辨率屏幕下严丝合缝。

## [V52.0] - 2026-01-16
### Fixed
- 分辨率修复: 解决禁用 DPI 感知导致 4K 屏幕被系统虚拟为 1080p（画面模糊、壁纸变小）的问题。
### Added
- DPI 策略: 重新启用 `SetProcessDpiAwarenessContext`，并添加 `HighDpiScaleFactorRoundingPolicy` 以防止 1px 像素偏差。

## [V48.0 - V51.0] - 2026-01-16 (Coordinates & Debugging)
### Fixed
- 多屏错位: 修复在股票软件等复杂多屏环境下，截图窗口坐标偏移或出现黑边的问题。
### Changed
- 坐标逻辑: 截图引擎从依赖窗口 `geometry()` 改为强制使用屏幕 `screen_info` 的绝对物理坐标。
- 窗口绑定: 强制使用 `setScreen` 将截图窗口锚定在鼠标所在的物理显示器上。

---

## [V47.0] - 2026-01-13 (Latest)
### Fixed
- UI Bug: 修复了工具栏分割线变量名引用错误导致的程序闪退问题 (Critical Hotfix)。
- 交互优化: 移除文字输入框的默认占位符，点击屏幕即显示空白光标，不再出现默认字符。

### Changed
- UI 细节: 工具栏分隔符从字符 `|` 升级为专业的垂直分割线 (`QFrame`)，视觉更加整洁。

## [V46.0] - 2026-01-13
### Changed
- UI 适配: 加宽字号下拉框宽度，解决大字号数字显示不全的问题。
- 图标美化: 字号选择器右侧图标替换为自定义的 SVG 上下箭头 (⇵) 样式，更具现代感。

## [V45.0] - 2026-01-13
### Fixed
- Crash Fix: 补全缺失的 `show_toolbar` 定位函数，修复截图完成时的崩溃问题。

### Added
- 功能增强: 文字工具升级为下拉菜单选择，支持 12px-72px 多档字号，且支持实时预览调整。

## [V42.0] - 2026-01-13
### Added
- 核心升级: 实现"原地文字输入" (Overlay Input)，点击屏幕直接出现透明输入框，所见即所得，回车确认。

### Changed
- UI 重塑: 工具栏全面升级为深色磨砂质感，图标尺寸加大，颜色选择器增加选中光圈特效。

### Fixed
- Bug 修复: 彻底解决箭头工具计算坐标时的类型错误 (`TypeError`) 崩溃问题。

## [V41.0] - 2026-01-13
### Added
- 核心重构: 引入"屏幕定格"机制，截图触发瞬间画面静止，提供稳定的绘图画布。
- 新增工具: 新增悬浮标注工具栏，包含矩形 (⬜)、圆形 (⭕)、箭头 (↗)、画笔 (✎) 及撤销 (↶) 功能。
- 体验优化: 支持右键单击取消当前选中的绘图工具，再次右键退出截图。

---

## [V40.0] - 2026-01-05
### Added
- UI 美化: 新增自动圆角裁剪算法。
- 图标优化: 实现 `logo.ico` 在托盘显示时自动变为圆形，且支持打包命令将图标内置。

## [V39.0]
### Fixed
- 高清修复: 引入像素密度比 (DPR) 计算，修复 2K/4K 高分屏缩放下截图尺寸偏小的问题。
- 层级修复: 截图窗口改为 `showFullScreen`，强制覆盖任务栏，解决无法截取任务栏的问题。

## [V38.0]
### Removed
- 极简版: 移除"设置双击速度"功能及菜单入口。
- 菜单精简: 托盘菜单仅保留：GitHub、右键管理、退出。

## [V37.0]
### Changed
- 功能调整: 移除热键设置功能，截图热键固定为 `Ctrl+1`。

## [V36.0]
### Added
- 尝试: 新增按键录制窗口（*后因需求变更撤销*）。

## [V35.0]
### Fixed
- 打包修复: 增加 `resource_path` 资源定位函数。
- Bug 修复: 解决打包为单文件 (`-F`) 后，托盘图标无法读取导致显示默认图标的问题。

## [V34.0]
### Fixed
- 核心修复: 重写 `RegistryManager`，增加 EXE 环境判断 (`sys.frozen`)。
- Bug 修复: 解决打包后右键菜单找不到程序路径导致功能失效的问题。

## [V33.0]
### Changed
- 文案修正: 统一菜单术语（"设置截图热键"、"设置返回上一层文件夹双击速度"）。

## [V32.0]
### Added
- 新增: 托盘菜单增加"访问 GitHub 主页"选项。
- 依赖: 引入 `webbrowser` 模块。

## [V31.0]
### Changed
- 体验优化: 移除右键存图成功后的弹窗提示，实现"静默保存"。

## [V30.0]
### Added
- 功能找回: 恢复丢失的"设置双击速度"功能及托盘入口。
### Changed
- 优化: 优化托盘菜单结构。

## [V29.0]
### Fixed
- 基准修复: 修复注册表写入权限问题，解决右键菜单偶尔失效的 Bug。

---

## 早期版本 (Early Access)

### [V25.0 - V28.0]
- 功能完善: 完善右键菜单逻辑，增加 `--paste` 启动参数。
- 调试: 增加诊断弹窗（用于调试剪贴板读取失败等问题）。

### [V22.0]
- 框架重构: GUI 框架从 `tkinter`/`pystray` 全面迁移至 PyQt6。
- UI: 界面美化，增加半透明遮罩效果。

### [V20.0]
- 新增功能: 初步尝试"右键菜单"集成。
- 核心: 编写注册表写入逻辑，支持右键调用脚本。

### [V15.0]
- 核心升级: 截图引擎从 `PIL` 迁移至 `mss`，支持多显示器截图。

### [V11.0 - V14.0]
- 新增功能: 集成截图模块。
- 支持: 添加默认截图快捷键支持。

### [V10.0]
- UI 重构: 移除 CMD 黑框运行模式。
- 核心: 加入系统托盘图标（Tray Icon），程序最小化到后台运行。

### [V5.0 - V9.0]
- 智能识别: 引入 `UIAutomation` 库，实现"空白处"智能识别，防止双击文件时触发返回。
- 配置: 增加 `config.json` 配置文件支持。

### [V2.0 - V4.0]
- 优化: 优化双击判定逻辑，解决单击误触问题。
- 限制: 引入 `is_explorer_window` 判断，限制仅在资源管理器生效。

### [V1.0]
- 项目初始化。
- 基础功能: 监听鼠标左键双击。
- 核心逻辑: 发送 `Alt+Up` 模拟返回上一级。